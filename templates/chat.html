<!doctype html>
<html lang="uk">
<head>
  <meta charset="utf-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1, viewport-fit=cover" />
  <title>Vova & Mari Chat</title>

  <style>
    html, body { height: 100%; margin: 0; }
    body { font-family: system-ui, -apple-system, Segoe UI, Roboto, Arial, sans-serif; background: #f5f6f7; }

    .app {
      height: 100%;
      display: flex;
      flex-direction: column;
      box-sizing: border-box;
    }

    .messages {
      flex: 1;
      overflow-y: auto;
      -webkit-overflow-scrolling: touch;
      padding: 16px 12px 12px;
      display: flex;
      flex-direction: column;
      gap: 10px;
      box-sizing: border-box;
    }

    .bubble {
      max-width: min(78%, 520px);
      padding: 10px 12px;
      border-radius: 14px;
      background: #4c7df0;
      color: white;
      align-self: flex-end;
      box-shadow: 0 1px 2px rgba(0,0,0,.08);
      word-wrap: break-word;
    }
    .bubble.left { background: #ffffff; color: #111; align-self: flex-start; }

    .meta { font-size: 12px; opacity: .8; margin-bottom: 6px; }

    .composer {
      display: flex;
      gap: 8px;
      padding: 10px 12px;
      background: #ffffff;
      border-top: 1px solid #e6e6e6;
      box-sizing: border-box;
    }

    input {
      flex: 1;
      font-size: 16px;
      padding: 10px 12px;
      border-radius: 12px;
      border: 1px solid #ddd;
      outline: none;
    }
    input:focus { border-color: #4c7df0; }

    button {
      padding: 10px 16px;
      border: none;
      border-radius: 12px;
      background: #4c7df0;
      color: #fff;
      font-weight: 600;
      font-size: 16px;
    }
    button:active { opacity: 0.85; }

    /* ----- First-run picker modal ----- */
    .overlay {
      position: fixed;
      inset: 0;
      background: rgba(0,0,0,0.35);
      display: none;
      align-items: center;
      justify-content: center;
      padding: 20px;
      z-index: 9999;
    }
    .overlay.show { display: flex; }

    .modal {
      width: min(420px, 100%);
      background: #fff;
      border-radius: 16px;
      box-shadow: 0 10px 30px rgba(0,0,0,0.18);
      padding: 18px;
    }
    .modal h2 {
      margin: 0 0 8px;
      font-size: 18px;
    }
    .modal p {
      margin: 0 0 14px;
      color: #444;
      font-size: 14px;
      line-height: 1.35;
    }
    .pick-row {
      display: grid;
      grid-template-columns: 1fr 1fr;
      gap: 10px;
    }
    .pick-btn {
      padding: 12px 10px;
      border-radius: 14px;
      border: 1px solid #e6e6e6;
      background: #f6f7f9;
      font-weight: 700;
      font-size: 16px;
      cursor: pointer;
    }
    .pick-btn:active { opacity: .85; }

    /* Small debug badge (optional, but helpful) */
    .badge {
      position: fixed;
      right: 10px;
      bottom: 78px;
      background: rgba(17,17,17,0.72);
      color: #fff;
      font-size: 12px;
      padding: 6px 8px;
      border-radius: 10px;
      z-index: 10;
      display: none;
    }
    .badge.show { display: inline-block; }
  </style>
</head>

<body>
  <!-- First-run chooser -->
  <div id="overlay" class="overlay">
    <div class="modal">
      <h2>Who do you love? ðŸ’˜</h2>
      <p>Choose once on this device. If you choose <b>Vova</b>, you will write as <b>Maria</b>, and vice versa.</p>
      <div class="pick-row">
        <button class="pick-btn" type="button" id="pickVova">Vova</button>
        <button class="pick-btn" type="button" id="pickMaria">Maria</button>
      </div>
    </div>
  </div>

  <div id="senderBadge" class="badge"></div>

  <div class="app">
    <div id="messages" class="messages"></div>

    <form id="form" class="composer">
      <input id="text" placeholder="ÐŸÐ¾Ð²Ñ–Ð´Ð¾Ð¼Ð»ÐµÐ½Ð½Ñ" autocomplete="off" />
      <button type="submit">Send</button>
    </form>
  </div>

  <script>
    const $messages = document.getElementById('messages');
    const $form = document.getElementById('form');
    const $text = document.getElementById('text');

    const $overlay = document.getElementById('overlay');
    const $pickVova = document.getElementById('pickVova');
    const $pickMaria = document.getElementById('pickMaria');
    const $badge = document.getElementById('senderBadge');

    // --- One-time choice per device ---
    // love = "Vova" or "Maria"
    function getLove() {
      return localStorage.getItem('love');
    }
    function setLove(name) {
      localStorage.setItem('love', name);
    }

    // If love == Vova => sender = Maria; else sender = Vova
    function computeSender(love) {
      if (love === 'Vova') return 'Maria';
      if (love === 'Maria') return 'Vova';
      return null;
    }

    let LOVE = getLove();
    let SENDER = computeSender(LOVE);

    function showPickerIfNeeded() {
      if (!SENDER) {
        $overlay.classList.add('show');
      } else {
        $overlay.classList.remove('show');
      }
    }

    function updateBadge() {
      // If you don't want the badge, set show=false below.
      const show = false; // <- change to true if you want a small "You write as X" label
      if (!SENDER || !show) {
        $badge.classList.remove('show');
        return;
      }
      $badge.textContent = `You write as: ${SENDER}`;
      $badge.classList.add('show');
    }

    $pickVova.addEventListener('click', async () => {
      setLove('Vova');
      LOVE = 'Vova';
      SENDER = computeSender(LOVE);
      $overlay.classList.remove('show');
      updateBadge();
      await loadMessages(true);
      $text.focus();
    });

    $pickMaria.addEventListener('click', async () => {
      setLove('Maria');
      LOVE = 'Maria';
      SENDER = computeSender(LOVE);
      $overlay.classList.remove('show');
      updateBadge();
      await loadMessages(true);
      $text.focus();
    });

    // --- Smart autoscroll ---
    function isNearBottom(thresholdPx = 120) {
      const distance = $messages.scrollHeight - $messages.scrollTop - $messages.clientHeight;
      return distance < thresholdPx;
    }
    function scrollToBottom() {
      $messages.scrollTop = $messages.scrollHeight;
    }

    function renderMessage(m) {
      const div = document.createElement('div');
      const isMine = (m.sender === SENDER);
      div.className = 'bubble ' + (isMine ? '' : 'left');
      div.innerHTML =
        `<div class="meta">${m.sender} Â· ${new Date(m.timestamp).toLocaleTimeString([], {hour:'2-digit', minute:'2-digit'})}</div>
         <div>${m.text}</div>`;
      return div;
    }

    async function loadMessages(forceScroll = false) {
      // ÑÐºÑ‰Ð¾ Ñ‰Ðµ Ð½Ðµ Ð²Ð¸Ð±Ñ€Ð°Ð»Ð¸ "love" â€” Ð½Ðµ Ð¿Ñ–Ð´Ñ‚ÑÐ³ÑƒÑ”Ð¼Ð¾ Ñ‡Ð°Ñ‚ (Ñ‰Ð¾Ð± Ð½Ðµ Ð±ÑƒÐ»Ð¾ Ð¼ÐµÑ€ÐµÑ…Ñ‚Ñ–Ð½Ð½Ñ)
      if (!SENDER) return;

      const wasNearBottom = isNearBottom();
      const res = await fetch('/messages?limit=100');
      const data = await res.json();

      $messages.innerHTML = '';
      data.forEach(m => $messages.appendChild(renderMessage(m)));

      if (forceScroll || wasNearBottom) scrollToBottom();
    }

    $form.addEventListener('submit', async (e) => {
      e.preventDefault();
      if (!SENDER) return; // Ð¿Ð¾ÐºÐ¸ Ð½Ðµ Ð²Ð¸Ð±Ñ€Ð°Ð»Ð¸ love â€” Ð½Ðµ ÑˆÐ»ÐµÐ¼Ð¾

      const text = $text.value.trim();
      if (!text) return;

      await fetch('/messages', {
        method: 'POST',
        headers: {'Content-Type':'application/json'},
        body: JSON.stringify({ sender: SENDER, text })
      });

      $text.value = '';
      await loadMessages(true);
    });

    // viewport/keyboard smoothness
    if (window.visualViewport) {
      window.visualViewport.addEventListener('resize', () => {
        if (isNearBottom()) {
          setTimeout(scrollToBottom, 50);
          setTimeout(scrollToBottom, 250);
        }
      });
    }

    // Init
    showPickerIfNeeded();
    updateBadge();
    loadMessages(true);
    setInterval(() => loadMessages(false), 2000);
  </script>
</body>
</html>
